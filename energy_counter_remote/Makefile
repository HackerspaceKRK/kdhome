# Generated by KD build system

CC=arm-none-eabi-gcc-col
CXX=arm-none-eabi-g++-col
OUTPUT=main.elf

F_CPU=8000000
RAMSIZE=2048

DEFINES=-DSTM32F0XX_LD -DPRINTF -DF_CPU=$(F_CPU) -DRAMSIZE=$(RAMSIZE)
INCLUDEPATH=-I. -Ikdusb -I/home/krystiand/prog/_uc/armtest/arm-public -I../kdutils/chips
LIBS=-lm -lc

CFLAGS=-mcpu=cortex-m0 -msoft-float -mthumb -nostartfiles -ggdb -Werror=implicit -O0 -fdata-sections -ffunction-sections
CFLAGS+=$(DEFINES)
CFLAGS+=$(INCLUDEPATH)
LFLAGS=-Wl,--relax,--gc-sections -Wl,-gc-sections -Wl,-Map=build/$(OUTPUT).map -Wl,-T main.ld
LFLAGS+=$(LIBS)

STM32_FLASHER=stm32-flasher

all: prepare build/$(OUTPUT)
	arm-none-eabi-objcopy -O binary build/$(OUTPUT) build/$(OUTPUT).bin
	arm-none-eabi-objcopy -O ihex build/$(OUTPUT) build/$(OUTPUT).hex
	arm-none-eabi-objdump -h -S build/$(OUTPUT) > build/$(OUTPUT).lst
	arm-none-eabi-size build/$(OUTPUT)

prepare:
	mkdir -p build/

build/main.o: main.c
	$(CC) $(CFLAGS) -c $< -o $@

build/isr_f0.o: isr_f0.c
	$(CC) $(CFLAGS) -c $< -o $@

build/_home_krystiand_prog__uc_armtest_arm-public_delay.o: /home/krystiand/prog/_uc/armtest/arm-public/delay.c
	$(CC) $(CFLAGS) -c $< -o $@

build/_home_krystiand_prog__uc_armtest_arm-public_myprintf.o: /home/krystiand/prog/_uc/armtest/arm-public/myprintf.c
	$(CC) $(CFLAGS) -c $< -o $@

build/__kdutils_chips_RFM70.o: ../kdutils/chips/RFM70.c
	$(CC) $(CFLAGS) -c $< -o $@

build/__kdutils_chips_RFM70_init.o: ../kdutils/chips/RFM70_init.c
	$(CC) $(CFLAGS) -c $< -o $@

build/$(OUTPUT): build/main.o build/isr_f0.o build/_home_krystiand_prog__uc_armtest_arm-public_delay.o build/_home_krystiand_prog__uc_armtest_arm-public_myprintf.o build/__kdutils_chips_RFM70.o build/__kdutils_chips_RFM70_init.o
	$(CC) $(CFLAGS) $^ $(LFLAGS) -o $@

flash:
ifndef port
	$(error port must be specified (eg. /dev/ttyUSB0))
endif
	$(STM32_FLASHER) --device=$(port) --speed=115200 --erase --flash  build/$(OUTPUT).bin
